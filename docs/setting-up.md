# Sentinel Set Up

Sentinel is a service that allows for running Electron apps against new versions of Electron in order to see early warning signs for bugs or breaking changes in Electron.

## Registering Your App

To register your app for the Sentinel Service, apps should sign up [here](https://electron-sentinel.herokuapp.com/signup).

You will need to create an account by registering your name, your app's name, and a password. You will also need to provide webhooks for 

After registering yourself as an app on Sentinel, you can change or update webhooks [in settings](https://electron-sentinel.herokuapp.com/settings).

There are two possible modes an app can use to take advantage of Sentinel's offered functionality:
1. A client provided by the service itself
2. A custom client implemented by your company

### Using the Default Client

Sentinel provides a default client for use by consumer apps, which can found [here](https://github.com/codebytere/sentinel-client).

This provided client works with GitHub Actions, and requires that you add a new workflow to your application's repository of the following [approximate form](https://github.com/codebytere/sentinel-client/blob/master/generate_sentinel_report.yml).

As the provided client works through GitHub Actions, it allows for testing on the following platforms:

* Windows Server 2019
* Ubuntu 18.04
* macOS Catalina 10.15

Your custom Sentinel reporting workflow may run your test suite using any test framework you like, but Sentinel will only be able to parse granular testing data from tests run with Mocha/Chai or Jest.

The provided client also assumes that you create a JSON file named `report.json` after running tests using a JSON reporter like [this one](https://jestjs.io/docs/en/cli.html#--outputfilefilename) for Jest. The output structure for that test report can be found [here](https://jestjs.io/docs/en/configuration#testresultsprocessor-string).

### Creating a Custom Client

If you are working with a repository which makes it difficult to adhere to requirements of the provided client, you can also create and provision your own custom client. This client will be responsible for:

1. Receiving webhooks from Sentinel
2. Triggering platform-specific CI jobs
3. Reporting the results of those jobs back to the primary Sentinel service

When a new Electron nightly is published to GitHub, Sentinel triggers webhooks to all registered apps for each of the platforms they have chosen to test with. These webhooks contains information in the following shape:

```js
{
  platformInstallData: {
    platform, // 'windows', 'macos', or 'linux'
    link // https://github.com/electron/nightlies/releases/download/v11.0.0-nightly.20200618/electron-v11.0.0-nightly.20200618-darwin-x64.zip
  },
  versionQualifier, // v11.0.0-nightly.20200629
  reportCallback, // https://electron-sentinel.herokuapp.com/reports/9
  commitHash // dd04473a97b8f120cdd749ee627abd0a5f69aadb
}
```

When your client receives this information at your chosen endpoint, Sentinel expects to get back the number of reports it should expect to recieve. If for example you only want to test on latest stable releases, and not nightlies or beta versionss, you could choose to tell Sentinel that it should expect no reports if the release is a `master` nightly or a beta.

Sentinel also expects to receive a session token generated by your client for a given nightly, so that it is able to associate the test data it receives with a a given report.

This information should returned to the initial endpoint in the following form:

```js
{
  sessionToken, // 'a121w32ddd'
  reportsExpected, // 0 or more
}
```

Once you have recieved installation and testing information for a given release, you should initiate a CI job with the information. For each platform you test on, Sentinel expects to recieve information `POST`ed to the `reportCallback` with the following shape:

```js
status, // 'Ready',' Passed', 'Failed', 'Pending', 'Skipped', or 'Not Run'.
arch, // e.g. 'arm', 'arm64', 'ia32', 'x86', 'amd64'.
os, // friendlier os name, e.g. 'macos', 'windows', or 'linux'.
sourceLink, // (optional) A link to your source code .
timeStart, // Date e.g 2020/05/29 19:37:40
timeStop, // Date e.g 2020/05/29 19:37:40
totalPassed, // The total number of test that passed.
totalSkipped, // The total number of test that were skipped.
totalWarnings, // The total number of test that produced warnings.
totalFailed, // The total number of test that failed.
logfileLink, // A link to a file containing logging output, with redacted information removed.
ciLink, // (optional) A link to the CI output.
testAgent: {
  platform, // 'darwin', 'linux', 'win32'
  cpus: {
    cores, // The number of cores, e.g. 8.
    model, // 'Intel(R) Core(TM) i7 CPU 860  @ 2.80GHz'.
    speed // CPU speed in MHz, e.g 2926,
  }
  freeMem, // The amount of free system memory in bytes as an integer.
  release, // The operating system as a string.
  totalMem, // The total amount of system memory in bytes as an integer.
  endianness // String identifying the endianness of the CPU, e.g. 'BE' or 'LE'.
}
```

Most information for the `testAgent` propperty can be collected using the [`os`](https://nodejs.org/api/os.html) module built into Node.js.

After submission, your data should be available on the [primary website](https://electron-sentinel.herokuapp.com/) correspondent to the date of submission.